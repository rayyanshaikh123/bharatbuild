Alright. I‚Äôll give you a **single, clean, structured ‚Äúmental model‚Äù of your entire backend**, exactly as it exists today after all our discussions and implementations.
This is **not code**, this is **system context** ‚Äî something you can hand to *any developer / AI / architect* and they‚Äôll understand your backend immediately.

---

# üèóÔ∏è COMPLETE BACKEND CONTEXT ‚Äì PROJECT OVERVIEW

This backend is a **construction project management system** designed for **real-world, low-network environments**, with **strict role-based control**, **financial accountability**, **auditability**, and **future AI-driven intelligence**.

It is built around **projects**, **plans**, **daily execution (DPR)**, **materials**, **attendance**, **wages**, **analytics**, **reports**, **audit logs**, and **offline synchronization**.

---

## 1Ô∏è‚É£ CORE ROLES & ACCESS MODEL

### üîê Roles in the System

| Role              | Purpose                      | Key Powers                                   |
| ----------------- | ---------------------------- | -------------------------------------------- |
| **OWNER**         | Organization-level authority | View everything, analytics, reports, audits  |
| **MANAGER**       | Project-level authority      | Approvals, planning, budgets, delays         |
| **SITE_ENGINEER** | Field execution              | DPRs, attendance approval, material requests |
| **LABOUR**        | On-site workforce            | Check-in / check-out attendance              |

---

## 2Ô∏è‚É£ ORGANIZATION ‚Üí PROJECT ‚Üí EXECUTION HIERARCHY

```
ORGANIZATION
 ‚îî‚îÄ‚îÄ PROJECT
      ‚îú‚îÄ‚îÄ PLANS
      ‚îÇ    ‚îî‚îÄ‚îÄ PLAN_ITEMS (tasks)
      ‚îú‚îÄ‚îÄ DPRs (Daily Progress Reports)
      ‚îú‚îÄ‚îÄ MATERIAL_REQUESTS ‚Üí MATERIAL_BILLS
      ‚îú‚îÄ‚îÄ ATTENDANCE ‚Üí WAGES
      ‚îú‚îÄ‚îÄ LEDGER (computed)
      ‚îú‚îÄ‚îÄ AUDIT_LOGS
```

Everything eventually **rolls up to the Project**, and then to the **Organization**.

---

## 3Ô∏è‚É£ AUTHORIZATION PHILOSOPHY (VERY IMPORTANT)

### Authentication

* JWT/session-based
* User identity + role resolved early

### Authorization (ENFORCED EVERYWHERE)

* `ownerCheck`
* `managerCheck`
* `engineerCheck`
* `labourCheck`

### Contextual Authorization

Even after role check, **context is verified**:

* Engineer must be **ACTIVE in project**
* Manager must be **ASSIGNED to project**
* Owner must **own the organization**
* Labour must be **approved for project**

üö´ No cross-project
üö´ No cross-organization
üö´ No role escalation

---

## 4Ô∏è‚É£ PROJECT PLANNING FLOW

### üìÖ Plans & Plan Items

* Created by **Manager**
* Represent *intended project timeline*
* Each **Plan Item** has:

  * start_date
  * end_date
  * status (PENDING / COMPLETED / DELAYED)
  * priority (0 default, 1‚Äì5 scale)
  * completed_at
  * delay JSONB (reason + DPR references)

### Progress Tracking

* Progress is **derived**, not manually entered:

  * total plan items
  * completed plan items
  * delayed items
* Used for:

  * timelines
  * dashboards
  * reports

---

## 5Ô∏è‚É£ DAILY EXECUTION ‚Äì DPR (Daily Progress Report)

### DPR Purpose

* Captures **what happened on site today**
* Written by **Site Engineer**
* Free-text + structured metadata
* Can be AI-processed later

### DPR Used For

* Delay root cause analysis
* Material consumption extraction
* Audit references
* Timeline explanations

---

## 6Ô∏è‚É£ MATERIAL MANAGEMENT FLOW

### Material Request

* Created by **Site Engineer**
* Can be:

  * DPR-linked
  * Standalone (limited per month)
* Status: PENDING ‚Üí APPROVED / REJECTED
* Approved by **Manager**

### Material Bill

* Uploaded by **Site Engineer**
* Can be:

  * Linked to approved request
  * Orphan (owner-controlled)
* Approved by **Manager**

### Financial Impact

* On approval:

  ```
  projects.current_invested += bill.total_amount
  ```
* Done **inside DB transaction**

---

## 7Ô∏è‚É£ ATTENDANCE SYSTEM (MANUAL VERIFICATION MODEL)

‚ö†Ô∏è **There is NO auto-attendance approval by manager**

### Attendance Rules

* Attendance is **verified / approved by Site Engineer**
* Labour only performs:

  * Check-in
  * Check-out

### Geofence

* Stored as `projects.geofence (JSONB)`
* Used during check-in/out
* Offline-compatible

### Attendance Structure

* One attendance per labour per day
* Multiple sessions allowed (breaks)
* Work hours computed from sessions

---

## 8Ô∏è‚É£ WAGES FLOW

### Wage Rates

* Defined per project
* **Created / edited ONLY by Manager**
* Engineers do NOT enter rates

### Wage Creation

* Based on **approved attendance**
* Status: PENDING ‚Üí APPROVED / REJECTED
* Approved by **Manager**

### Financial Impact

* On approval:

  ```
  projects.current_invested += wage.total_amount
  ```

---

## 9Ô∏è‚É£ LEDGER (DERIVED, NOT STORED)

Ledger is a **computed view**:

* Material bills
* Approved wages
* Manual adjustments

Used for:

* Reports
* Dashboards
* Financial traceability

---

## üîç 10Ô∏è‚É£ AUDIT LOGGING (IMMUTABLE)

### What Is Logged

* ALL UPDATE / DELETE operations
* Across:

  * Materials
  * Wages
  * Plans
  * Projects
  * Attendance
  * Organizations

### Audit Data Captured

* entity_type
* entity_id
* action
* before / after
* changed_fields
* user_id + role
* project_id
* organization_id
* timestamp

### Visibility

| Role     | Audit Visibility    |
| -------- | ------------------- |
| Owner    | Entire organization |
| Manager  | Assigned projects   |
| Engineer | Own actions only    |

---

## üîÑ 11Ô∏è‚É£ OFFLINE & SYNCHRONIZATION MODEL

### Client Side (Flutter)

* SQLite stores offline actions
* No business logic offline
* Payloads stored as-is

### Server Side

Tables:

* `sync_action_log`
* `sync_errors`
* `attendance.source`

### Sync Rules

* Idempotent
* Validated
* Authorized
* Rejected actions logged (never silent)

---

## ‚ö° 12Ô∏è‚É£ LOW NETWORK PERFORMANCE LAYER

### Purpose

* Field usage in poor connectivity
* Faster data transfer

### Technology

* GraphQL
* HTTP/2
* Brotli compression
* Pagination
* NO caching

### Structure

```
routes/labour/fast/
routes/engineer/fast/
```

Uses:

* Same services
* Same auth
* Same validations

---

## üìä 13Ô∏è‚É£ ANALYTICS, DASHBOARD & REPORTING

### Dashboards

* Owner: organization-wide
* Manager: assigned projects
* Derived from live data

### Reports

* Date filters
* Project filters
* PDF export
* AI-generated insights

---

## ü§ñ 14Ô∏è‚É£ AI INTEGRATION PHILOSOPHY

AI is:

* Advisory
* Analytical
* Non-authoritative

Used for:

* DPR material extraction
* Delay root cause summaries
* Anomaly detection
* Insight generation for reports

Never:

* Approves
* Modifies data
* Bypasses rules

---

## üß† FINAL SYSTEM CHARACTERISTICS

‚úÖ Role-safe
‚úÖ Audit-complete
‚úÖ Offline-first
‚úÖ Financially consistent
‚úÖ AI-ready
‚úÖ Scalable
‚úÖ Real-world construction friendly

---

If you want next, I can:

* Turn this into **official architecture documentation**
* Convert it into a **system diagram**
* Or generate a **single master prompt** that recreates the entire backend

Just say the word.
