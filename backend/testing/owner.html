<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Owner Dashboard - Testing</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }
      .section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .section h2 {
        color: #34495e;
        margin-top: 0;
      }
      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #2980b9;
      }
      button.danger {
        background: #e74c3c;
      }
      button.danger:hover {
        background: #c0392b;
      }
      button.success {
        background: #27ae60;
      }
      button.success:hover {
        background: #229954;
      }
      #output {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .input-group {
        margin: 10px 0;
      }
      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #34495e;
      }
      .input-group input,
      .input-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
      }
      .stored-data {
        background: #ecf0f1;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>üè¢ Owner Dashboard (Testing)</h1>

    <div class="section">
      <h2>Stored Data</h2>
      <div class="stored-data">
        <div>
          <strong>Organization ID:</strong> <span id="storedOrgId">None</span>
        </div>
        <div>
          <strong>Project ID:</strong> <span id="storedProjectId">None</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>1Ô∏è‚É£ Organization Management</h2>

      <div class="input-group">
        <label>Organization Name:</label>
        <input
          type="text"
          id="orgName"
          placeholder="My Construction Company"
          value="Test Org"
        />
      </div>

      <button onclick="createOrganization()">Create Organization</button>
      <button onclick="getMyOrganizations()">Get My Organizations</button>
      <button onclick="getOrganizationDetails()">
        Get Organization Details
      </button>
    </div>

    <div class="section">
      <h2>2Ô∏è‚É£ Manager Requests</h2>
      <button onclick="getManagerRequests('PENDING')">
        Pending Manager Requests
      </button>
      <button onclick="getManagerRequests('APPROVED')" class="success">
        Approved Manager Requests
      </button>
      <button onclick="getManagerRequests('REJECTED')" class="danger">
        Rejected Manager Requests
      </button>
    </div>

    <div class="section">
      <h2>3Ô∏è‚É£ Engineer Requests</h2>
      <button onclick="getEngineerRequests('PENDING')">
        Pending Engineer Requests
      </button>
      <button onclick="getEngineerRequests('APPROVED')" class="success">
        Approved Engineer Requests
      </button>
      <button onclick="getEngineerRequests('REJECTED')" class="danger">
        Rejected Engineer Requests
      </button>
    </div>

    <div class="section">
      <h2>4Ô∏è‚É£ Projects</h2>
      <button onclick="getAllProjects()">View All Projects</button>
      <button onclick="getProjectDetails()">Get Project Details</button>
    </div>

    <div class="section">
      <h2>5Ô∏è‚É£ Analytics</h2>
      <button onclick="getAnalyticsOverview()">Analytics Overview</button>
      <button onclick="getProjectAnalytics()">Project Analytics</button>
    </div>

    <div class="section">
      <h2>6Ô∏è‚É£ Ledger & Delays</h2>
      <button onclick="getProjectLedger()">Project Ledger</button>
      <button onclick="getProjectDelays()">Project Delays</button>
    </div>

    <div class="section">
      <h2>7Ô∏è‚É£ Materials & Wages</h2>
      <button onclick="getMaterialRequests()">Material Requests</button>
      <button onclick="getMaterialBills()">Material Bills</button>
      <button onclick="getWages()">Wages</button>
    </div>

    <div class="section">
      <h2>8Ô∏è‚É£ Plans & DPRs</h2>
      <button onclick="getPlans()">Get Plans</button>
      <button onclick="getDPRs()">Get DPRs</button>
    </div>

    <div class="section">
      <h2>9Ô∏è‚É£ Audit Logs</h2>
      <button onclick="getAuditLogs()">Get Audit Logs</button>
    </div>

    <div class="section">
      <h2>üö™ Session</h2>
      <button onclick="getProfile()">Get My Profile</button>
      <button onclick="logout()" class="danger">Logout</button>
    </div>

    <div class="section">
      <h2>üìã API Response</h2>
      <div id="output">Waiting for API calls...</div>
    </div>

    <script>
      const API_BASE = "http://localhost:3001";
      let currentOrgId = null;
      let currentProjectId = null;

      function updateStoredData() {
        document.getElementById("storedOrgId").textContent =
          currentOrgId || "None";
        document.getElementById("storedProjectId").textContent =
          currentProjectId || "None";
      }

      function log(message, data = null) {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        let logMessage = `[${timestamp}] ${message}\n`;

        if (data) {
          logMessage += JSON.stringify(data, null, 2) + "\n";
        }

        output.textContent = logMessage + "\n" + output.textContent;
        console.log(message, data);
      }

      async function apiCall(method, endpoint, body = null) {
        try {
          const options = {
            method,
            headers: { "Content-Type": "application/json" },
            credentials: "include",
          };

          if (body) {
            options.body = JSON.stringify(body);
          }

          log(`${method} ${endpoint}`, body);

          const response = await fetch(`${API_BASE}${endpoint}`, options);
          const data = await response.json();

          if (!response.ok) {
            log(`‚ùå Error (${response.status})`, data);
            alert(`Error: ${data.error || "Unknown error"}`);
            return null;
          }

          log(`‚úÖ Success (${response.status})`, data);
          return data;
        } catch (error) {
          log(`‚ùå Network Error`, { error: error.message });
          alert(`Network Error: ${error.message}`);
          return null;
        }
      }

      // 1Ô∏è‚É£ Organization Management
      async function createOrganization() {
        const name = document.getElementById("orgName").value;
        if (!name) {
          alert("Please enter organization name");
          return;
        }

        const data = await apiCall("POST", "/owner/create-organization", {
          name,
          address: "Test Address",
          office_phone: "1234567890",
          org_type: "CONSTRUCTION",
        });
        if (data && data.organization) {
          currentOrgId = data.organization.id;
          updateStoredData();
          alert(`Organization created! ID: ${currentOrgId}`);
        }
      }

      async function getMyOrganizations() {
        const data = await apiCall("GET", "/owner/organizations");
        if (data && data.organizations && data.organizations.length > 0) {
          currentOrgId = data.organizations[0].id;
          updateStoredData();
        }
      }

      async function getOrganizationDetails() {
        if (!currentOrgId) {
          alert("Please get organizations first to set organization ID");
          return;
        }
        await apiCall("GET", `/owner/organization/${currentOrgId}`);
      }

      // 2Ô∏è‚É£ Manager Requests
      async function getManagerRequests(status) {
        await apiCall("GET", `/owner/organization-managers?status=${status}`);
      }

      // 3Ô∏è‚É£ Engineer Requests
      async function getEngineerRequests(status) {
        await apiCall("GET", `/owner/organization-engineers?status=${status}`);
      }

      // 4Ô∏è‚É£ Projects
      async function getAllProjects() {
        if (!currentOrgId) {
          alert("Please get organizations first");
          return;
        }
        const data = await apiCall(
          "GET",
          `/owner/project/all/projects?organizationId=${currentOrgId}`,
        );
        if (data && data.projects && data.projects.length > 0) {
          currentProjectId = data.projects[0].id;
          updateStoredData();
        }
      }

      async function getProjectDetails() {
        if (!currentOrgId || !currentProjectId) {
          alert("Please get organizations and projects first");
          return;
        }
        await apiCall(
          "GET",
          `/owner/project/project/${currentProjectId}?organizationId=${currentOrgId}`,
        );
      }

      // 5Ô∏è‚É£ Analytics
      async function getAnalyticsOverview() {
        await apiCall("GET", "/owner/analytics/overview");
      }

      async function getProjectAnalytics() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall("GET", `/owner/analytics/project/${currentProjectId}`);
      }

      // 6Ô∏è‚É£ Ledger & Delays
      async function getProjectLedger() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall(
          "GET",
          `/owner/ledger/project/${currentProjectId}?start_date=2024-01-01&end_date=2024-12-31`,
        );
      }

      async function getProjectDelays() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall("GET", `/owner/delays/project/${currentProjectId}`);
      }

      // 7Ô∏è‚É£ Materials & Wages
      async function getMaterialRequests() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall(
          "GET",
          `/owner/material/requests?project_id=${currentProjectId}`,
        );
      }

      async function getMaterialBills() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall(
          "GET",
          `/owner/material/bills?project_id=${currentProjectId}`,
        );
      }

      async function getWages() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall("GET", `/owner/wages?project_id=${currentProjectId}`);
      }

      // 8Ô∏è‚É£ Plans & DPRs
      async function getPlans() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall("GET", `/owner/plan/plans/${currentProjectId}`);
      }

      async function getDPRs() {
        if (!currentProjectId) {
          alert("Please get projects first");
          return;
        }
        await apiCall("GET", `/owner/dpr/projects/${currentProjectId}/dprs`);
      }

      // 9Ô∏è‚É£ Audit Logs
      async function getAuditLogs() {
        await apiCall("GET", "/owner/audits?page=1&limit=20");
      }

      // üö™ Session
      async function getProfile() {
        await apiCall("GET", "/owner/profile");
      }

      async function logout() {
        const data = await apiCall("POST", "/auth/owner/logout");
        if (data) {
          alert("Logged out successfully!");
          window.location.href = "auth.html";
        }
      }

      // Auto-load profile on page load
      window.onload = () => {
        log("Owner Dashboard loaded");
        getProfile();
      };
    </script>
  </body>
</html>
